<!DOCTYPE html>
<html lang="ru">
<head>
 <link rel="icon" type="image/png" href="icon1.png">
 <link rel="apple-touch-icon" href="icon1.png">
 <meta name="apple-mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>DJ Плеер</title>
 <link rel="manifest" href="manifest.json">
 <style>
 body {
  margin: 0;
 font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
 background: #121212;
 color: white;
 }

 .App {
 text-align: center;
 padding: 20px;
 }

 .App-header h1 {
 color: #1db954;
 margin-bottom: 30px;
 }

 .file-upload {
 margin: 20px 0;
 width: 100%;
 }

 .upload-area {
 border: 2px dashed #1db954;
 border-radius: 15px;
 padding: 40px 20px;
 text-align: center;
 cursor: pointer;
 transition: all 0.3s ease;
 background: rgba(29, 185, 84, 0.05);
 }

 .upload-area:hover, .upload-area.dragging {
 background: rgba(29, 185, 84, 0.1);
 border-color: #1ed760;
 }

 .upload-content {
 color: #1db954;
 }

 .upload-icon {
 font-size: 48px;
 margin-bottom: 15px;
 }

 .upload-content p {
 margin: 10px 0;
 font-size: 18px;
 font-weight: bold;
 }

 .upload-content small {
 color: #666;
 display: block;
 margin-bottom: 15px;
 }

 .upload-button {
 background: #1db954;
 color: white;
 border: none;
 padding: 12px 24px;
 border-radius: 25px;
 cursor: pointer;
 font-size: 16px;
 font-weight: bold;
 transition: background 0.3s;
 }

 .upload-button:hover {
 background: #1ed760;
 }

 .local-files-list {
 margin-top: 20px;
 text-align: left;
 background: #282828;
 padding: 15px;
 border-radius: 10px;
 }

 .local-files-list h3 {
 color: #1db954;
 margin-bottom: 10px;
 }

 .local-files-list ul {
 list-style: none;
 padding: 0;
 }

 .local-files-list li {
 background: rgba(29, 185, 84, 0.1);
 margin: 5px 0;
 padding: 8px 12px;
 border-radius: 5px;
 border-left: 3px solid #1db954;
 }

 .audio-player {
 background: #282828;
 border-radius: 10px;
 padding: 15px;
 margin: 10px 0;
 }

 .audio-player.playing {
 border: 2px solid #1db954;
 background: rgba(29, 185, 84, 0.1);
 }

 .player-controls {
 display: flex;
 align-items: center;
 gap: 15px;
 }

 .play-button {
 background: #1db954;
 border: none;
 border-radius: 50%;
 width: 40px;
 height: 40px;
 font-size: 16px;
 cursor: pointer;
 display: flex;
 align-items: center;
 justify-content: center;
 }

 .play-button.playing {
 background: #1db954;
 }

 .progress-container {
 display: flex;
 align-items: center;
 gap: 10px;
 flex-grow: 1;
 }

 .time-current, .time-duration {
 color: #b3b3b3;
 font-size: 12px;
 min-width: 40px;
 }

 .progress-bar {
 flex-grow: 1;
 height: 4px;
 border-radius: 2px;
 background: #535353;
 outline: none;
 -webkit-appearance: none;
 }

 .progress-bar::-webkit-slider-thumb {
 -webkit-appearance: none;
 width: 12px;
 height: 12px;
 border-radius: 50%;
 background: #1db954;
 cursor: pointer;
 }

 .track-info {
 display: flex;
 flex-direction: column;
 min-width: 150px;
 text-align: left;
 }

 .track-info strong {
 color: white;
 font-size: 14px;
 }

 .track-info span {
 color: #b3b3b3;
 font-size: 12px;
 }

 .now-playing {
 color: #1db954;
 font-weight: bold;
 font-size: 12px;
 margin-top: 2px;
 }

 .playlist {
 margin-top: 30px;
 text-align: left;
 }

 .playlist h3 {
 color: #1db954;
 border-bottom: 2px solid #1db954;
 padding-bottom: 10px;
 }
 
 .ios-warning {
 background: #ff6b6b;
 color: white;
 padding: 10px;
 border-radius: 5px;
 margin: 10px 0;
 font-size: 14px;
 }
 </style>
</head>
<body>
 <div id="root"></div>

 <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
 <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
 <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
 <script src="playlist-manager.js"></script>
 
 <script type="text/babel">
 const { useState, useRef, useEffect } = React;

 // Компонент FileUpload
 function FileUpload({ onFilesSelect }) {
 const fileInputRef = useRef(null);
 const [isDragging, setIsDragging] = useState(false);

 const handleFileSelect = (files) => {
 const fileList = Array.from(files);
 if (fileList.length > 0) {
 onFilesSelect(fileList);
 }
 };

 const handleInputChange = (event) => {
 handleFileSelect(event.target.files);
 };

 const handleClick = () => {
 fileInputRef.current.click();
 };

 const handleDragOver = (event) => {
 event.preventDefault();
 setIsDragging(true);
 };

 const handleDragLeave = (event) => {
 event.preventDefault();
 setIsDragging(false);
 };

 const handleDrop = (event) => {
 event.preventDefault();
 setIsDragging(false);
 const files = event.dataTransfer.files;
 handleFileSelect(files);
 };

 return (
 React.createElement('div', { className: 'file-upload' },
 React.createElement('input', {
 type: 'file',
 ref: fileInputRef,
 onChange: handleInputChange,
 multiple: true,
 accept: '.mp3,.wav,.m4a,.aac',
 style: { display: 'none' }
 }),
 React.createElement('div', {
 className: `upload-area ${isDragging ? 'dragging' : ''}`,
 onDragOver: handleDragOver,
 onDragLeave: handleDragLeave,
 onDrop: handleDrop,
 onClick: handleClick
 },
 React.createElement('div', { className: 'upload-content' },
 React.createElement('div', { className: 'upload-icon' }, '📁'),
 React.createElement('p', null, 'Нажмите или перетащите файлы для загрузки'),
 React.createElement('small', null, 'Поддерживаемые форматы: MP3, WAV, M4A, AAC'),
 React.createElement('button', {
 className: 'upload-button',
 onClick: (e) => {
 e.stopPropagation();
 handleClick();
 }
 }, 'Выбрать файлы')
 )
 )
 )
 );
 }

 // Компонент AudioPlayer
 function AudioPlayer({ track, isPlaying, onPlay, onStop }) {
 const [currentTime, setCurrentTime] = useState(0);
 const [duration, setDuration] = useState(0);
 const audioRef = useRef(null);

 useEffect(() => {
 const audio = audioRef.current;
 
 const updateTime = () => setCurrentTime(audio.currentTime);
 const updateDuration = () => setDuration(audio.duration);
 const handleEnd = () => {
    onStop(); // ← ЭТА СТРОКА ВАЖНА!
    setCurrentTime(0);
    
    // Автопереход на следующий трек
    setTimeout(() => {
        if (onEnded) {
            onEnded(track.id);
        }
    }, 100);
};
  
 audio.addEventListener('timeupdate', updateTime);
 audio.addEventListener('loadedmetadata', updateDuration);
 audio.addEventListener('ended', handleEnd);

 return () => {
 audio.removeEventListener('timeupdate', updateTime);
 audio.removeEventListener('loadedmetadata', updateDuration);
 audio.removeEventListener('ended', handleEnd);
 };
 }, []);

 const togglePlay = () => {
 if (isPlaying) {
 audioRef.current.pause();
 onStop();
 } else {
 onPlay(track.id);
 audioRef.current.play()
 .then(() => {
 // Успешное воспроизведение
 })
 .catch(error => {
 console.error('Error playing audio:', error);
 onStop();
 });
 }
 };

 const handleSeek = (e) => {
 const seekTime = parseFloat(e.target.value);
 audioRef.current.currentTime = seekTime;
 setCurrentTime(seekTime);
 };

 const formatTime = (time) => {
 if (isNaN(time)) return '0:00';
 const minutes = Math.floor(time / 60);
 const seconds = Math.floor(time % 60);
 return `${minutes}:${seconds.toString().padStart(2, '0')}`;
 };

 return (
 React.createElement('div', { 
 className: `audio-player ${isPlaying ? 'playing' : ''}`
 },
 React.createElement('audio', { 
 ref: audioRef, 
 src: track.url,
 preload: 'metadata'
 }),
 React.createElement('div', { className: 'player-controls' },
 React.createElement('button', { 
 className: `play-button ${isPlaying ? 'playing' : ''}`, 
 onClick: togglePlay
 }, isPlaying ? '⏸️' : '▶️'),
 React.createElement('div', { className: 'progress-container' },
 React.createElement('span', { className: 'time-current' }, formatTime(currentTime)),
 React.createElement('input', {
 type: 'range',
 min: 0,
 max: duration || 0,
 value: currentTime,
 onChange: handleSeek,
 className: 'progress-bar'
 }),
 React.createElement('span', { className: 'time-duration' }, formatTime(duration))
 ),
 React.createElement('div', { className: 'track-info' },
 React.createElement('strong', null, track.name),
 React.createElement('span', null, track.artist),
 isPlaying && React.createElement('span', { className: 'now-playing' }, '▶️ Играет')
 )
 )
 )
 );
 }

 // Главный компонент App
function App() {
  const [localFiles, setLocalFiles] = useState([]);
  const [playlist, setPlaylist] = useState([]);
  const [currentTrackId, setCurrentTrackId] = useState(null);
  const [isIOS, setIsIOS] = useState(false);

  // Загрузка сохраненных треков при старте
  useEffect(() => {
    const loadSavedTracks = async () => {
      try {
        await window.playlistManager.init();
        const savedTracks = await window.playlistManager.getAllTracks();
        if (savedTracks.length > 0) {
          // ПРАВИЛЬНО ЗАГРУЖАЕМ ТРЕКИ В ПЛЕЙЛИСТ
          const loadedTracks = savedTracks.map(track => {
            const url = URL.createObjectURL(track.file);
            return {
              id: `saved-${track.id}`,
              name: track.file.name.replace(/\.(mp3|wav|m4a|aac)$/i, ''),
              artist: 'Локальный файл',
              duration: 'Неизвестно',
              url: url,
              isLocal: true,
              file: track.file
            };
          });
          setPlaylist(loadedTracks);
          console.log('Загружено треков:', loadedTracks.length);
        }
      } catch (error) {
        console.error('Ошибка загрузки плейлиста:', error);
      }
    };
    loadSavedTracks();
  }, []);
 // Определяем iOS
 useEffect(() => {
 const isAppleDevice = /iPad|iPhone|iPod/.test(navigator.userAgent);
 setIsIOS(isAppleDevice);
 }, []);

  const handleFilesSelect = async (files) => {
  // СОХРАНЯЕМ ФАЙЛЫ В БАЗУ ДАННЫХ
  for (const file of files) {
    try {
      await window.playlistManager.saveTrack(file);
      console.log('Сохранен файл:', file.name);
    } catch (error) {
      console.error('Ошибка сохранения:', error);
    }
  }
  
  setLocalFiles(files);
 
 const newTracks = files.map(file => {
 const url = URL.createObjectURL(file);
 return {
 id: `local-${Date.now()}-${file.name}`,
 name: file.name.replace(/\.(mp3|wav|m4a|aac)$/i, ''),
 artist: 'Локальный файл',
 duration: 'Неизвестно',
 url: url,
 isLocal: true,
 file: file
 };
 }); 
 setPlaylist(prev => [...prev, ...newTracks]);
 };

 const handlePlay = (trackId) => {
 // Останавливаем все аудио
 document.querySelectorAll('audio').forEach(audio => {
 audio.pause();
 audio.currentTime = 0;
 });
 setCurrentTrackId(trackId);
 };

 const handleStop = () => {
 setCurrentTrackId(null);
 };
 const handleTrackEnd = (endedTrackId) => {
    const currentIndex = playlist.findIndex(t => t.id === endedTrackId);
    if (currentIndex !== -1 && currentIndex < playlist.length - 1) {
        const nextTrack = playlist[currentIndex + 1];
        setCurrentTrackId(nextTrack.id);
    } else {
        setCurrentTrackId(null);
    }
};

 return (
 React.createElement('div', { className: 'App' },
 React.createElement('header', { className: 'App-header' },
 React.createElement('h1', null, 'DJ Плеер'),
 isIOS && React.createElement('div', { className: 'ios-warning' }, 
 'На iOS автопереход может не работать из-за ограничений браузера'
 ),
 React.createElement(FileUpload, { onFilesSelect: handleFilesSelect }),
 
 localFiles.length > 0 && React.createElement('div', { className: 'local-files-list' },
 React.createElement('h3', null, `Выбранные файлы (${localFiles.length}):`),
 React.createElement('ul', null,
 localFiles.map((file, index) =>
 React.createElement('li', { key: index }, file.name)
 )
 )
 ),
 
 playlist.length > 0 && React.createElement('div', { className: 'playlist' },
 React.createElement('h3', null, `Плейлист (${playlist.length} треков)`),
 playlist.map(track =>
 React.createElement(AudioPlayer, { 
 key: track.id, 
 track: track,
 isPlaying: currentTrackId === track.id,
 onPlay: handlePlay,
 onStop: handleStop,
  onEnded: handleTrackEnd 
})

 )
 )
 )
 )
 );
 }

 // Рендерим приложение
 ReactDOM.render(React.createElement(App), document.getElementById('root'));
 </script>
 <script>
// Регистрация сервис-воркера
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/service-worker.js')
            .then(function(registration) {
                console.log('✅ Сервис-воркер зарегистрирован:', registration);
            })
            .catch(function(error) {
                console.log('❌ Ошибка регистрации сервис-воркера:', error);
            });
    });
}

// Проверка оффлайн-статуса
window.addEventListener('online', function() {
    console.log('🌐 Онлайн');
    document.body.classList.remove('offline');
});

window.addEventListener('offline', function() {
    console.log('📴 Оффлайн');
    document.body.classList.add('offline');
});

if (!navigator.onLine) {
    document.body.classList.add('offline');
}
</script>

<style>
.offline::before {
    content: "📴 Оффлайн";
    position: fixed;
    top: 10px;
    right: 10px;
    background: #ff4444;
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 12px;
    z-index: 1000;
}
</style>
 <script src="playlist-manager.js"></script>

<script>
// Регистрация сервис-воркера
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/service-worker.js')
            .then(function(registration) {
                console.log('✅ Сервис-воркер зарегистрирован');
            })
            .catch(function(error) {
                console.log('❌ Ошибка сервис-воркера:', error);
            });
    });
}

// Проверка оффлайн-статуса
window.addEventListener('online', function() {
    document.body.classList.remove('offline');
});

window.addEventListener('offline', function() {
    document.body.classList.add('offline');
});

if (!navigator.onLine) {
    document.body.classList.add('offline');
}
</script>

<style>
.offline::before {
    content: "📴 Оффлайн";
    position: fixed;
    top: 10px;
    right: 10px;
    background: #ff4444;
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 12px;
    z-index: 1000;
}
</style>
 <script src="playlist-manager.js"></script>
<script src="service-worker.js"></script>
 <script>
// Визуальный дебаггер для iOS
setTimeout(() => {
  const debugInfo = document.createElement('div');
  debugInfo.style.cssText = `
    position: fixed; 
    top: 50px; 
    left: 10px; 
    background: rgba(0,0,0,0.8); 
    color: white; 
    padding: 10px; 
    border-radius: 5px; 
    font-size: 12px; 
    z-index: 9999;
    max-width: 300px;
  `;
  
  // Проверяем базовые вещи
  let status = '';
  
  if (!window.playlistManager) {
    status = '❌ PlaylistManager не загружен';
  } else {
    status = '✅ PlaylistManager загружен\n';
    
    // Проверяем базу
    window.playlistManager.init()
      .then(() => window.playlistManager.getAllTracks())
      .then(tracks => {
        status += `📀 В базе: ${tracks.length} треков`;
        debugInfo.textContent = status;
        
        // Если есть треки - пробуем загрузить в плейлист
        if (tracks.length > 0) {
          status += '\n🔄 Загружаю в плейлист...';
          debugInfo.textContent = status;
          
          // Здесь нужно вызвать загрузку треков в React
          // Но для этого нужно найти способ сообщить React
        }
      })
      .catch(error => {
        status += `❌ Ошибка базы: ${error.message}`;
        debugInfo.textContent = status;
      });
  }
  
  debugInfo.textContent = status;
  document.body.appendChild(debugInfo);
  
}, 1000);
</script>
</body>
</html>
